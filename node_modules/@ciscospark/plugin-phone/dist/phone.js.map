{"version":3,"sources":["../src/phone.js"],"names":["Phone","extend","session","connected","default","type","defaultFacingMode","values","registered","namespace","isCallingSupported","resolve","DetectRTC","require","isWebRTCSupported","register","spark","device","refresh","then","all","mercury","when","message","data","bufferState","locus","list","loci","forEach","trigger","make","parent","connect","deregister","disconnect","unregister","createLocalMediaStream","options","constraints","audio","video","initialize","args","prototype","listenTo","event","_onLocusEvent","url","dial","dialString","call"],"mappings":"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","file":"phone.js","sourcesContent":["/**!\n *\n * Copyright (c) 2016-2017 Cisco Systems, Inc. See LICENSE file.\n * @private\n */\n\nimport {SparkPlugin} from '@ciscospark/spark-core';\nimport {defaults} from 'lodash';\nimport Call from './call';\nimport {shouldRing} from './state-parsers';\nimport {getUserMedia} from './webrtc';\n\n/**\n * Incoming Call Event\n *\n * Emitted when a call begins and when {@link Phone#register} is invoked and\n * there are active calls.\n *\n * @event call:incoming\n * @instance\n * @memberof Phone\n * @type {Object}\n * @property {Call} call The incoming call\n */\n\n/**\n * @class\n * @extends SparkPlugin\n * The calling feature in the SDK is currently available in limited beta. If you'd like to join the beta program and share your feedback, please visit the [developer portal](https://developer.ciscospark.com/sdkaccess/). If you qualify, a Cisco employee will reach out to you.\n */\nconst Phone = SparkPlugin.extend({\n  session: {\n    /**\n     * Indicates whether or not the WebSocket is connected\n     * @instance\n     * @memberof Phone\n     * @member {Boolean}\n     * @readonly\n     */\n    connected: {\n      default: false,\n      type: `boolean`\n    },\n    /**\n     * Specifies the facingMode to be used by {@link Phone#dial} and\n     * {@link Call#answer} when no constraint is specified. Does not apply if\n     * - a {@link MediaStream} is passed to {@link Phone#dial} or\n     * {@link Call#answer}\n     * - constraints are passed to {@link Phone#dial} or  {@link Call#answer}\n     * The only valid values are `user` and `environment`. For any other values,\n     * you must provide your own constrains or {@link MediaStream}\n     * @default `user`\n     * @instance\n     * @memberof {Phone}\n     * @type {string}\n     */\n    defaultFacingMode: {\n      default: `user`,\n      type: `string`,\n      values: [`user`, `environment`]\n    },\n    /**\n     * indicates whether or not the client is registered with the Cisco Spark\n     * cloud\n     * @instance\n     * @memberof Phone\n     * @member {Boolean}\n     * @readonly\n     */\n    registered: {\n      default: false,\n      type: `boolean`\n    }\n  },\n\n  namespace: `phone`,\n\n  /**\n   * Indicates if the current browser appears to support webrtc calling. Note:\n   * at this time, there's no way to determine if the current browser supports\n   * h264 without asking for camera permissions\n   * @returns {Promise<Boolean>}\n   */\n  isCallingSupported() {\n    return new Promise((resolve) => {\n      // I'm not thrilled by this, but detectrtc breaks the global namespace in\n      // a way that screws up the browserOnly/nodeOnly test helpers.\n      // eslint-disable-next-line global-require\n      const DetectRTC = require(`detectrtc`);\n      resolve(DetectRTC.isWebRTCSupported);\n    });\n  },\n\n  /**\n   * Registers the client with the Cisco Spark cloud and starts listening for\n   * WebSocket events.\n   *\n   * Subsequent calls refresh the device registration.\n   * @instance\n   * @memberof Phone\n   * @returns {Promise}\n   */\n  register() {\n    // Ideally, we could call spark.refresh via spark-core, but it doesn't know\n    // about the wdm plugin, and all of the leaky abstractions I can think of\n    // seem risky.\n\n    return this.spark.device.refresh()\n      .then(() => {\n        if (this.connected) {\n          return Promise.resolve();\n        }\n        return Promise.all([\n          this.spark.mercury.when(`event:mercury.buffer_state`)\n            .then(([message]) => {\n              if (message.data.bufferState.locus === `UNKNOWN`) {\n                return this.spark.locus.list();\n              }\n              return Promise.resolve();\n            })\n            .then((loci) => {\n              if (!loci) {\n                return;\n              }\n              // eslint-disable-next-line max-nested-callbacks\n              loci.forEach((locus) => {\n                this.trigger(`call:incoming`, Call.make({\n                  locus\n                }, {\n                  parent: this.spark\n                }));\n              });\n            }),\n          this.spark.mercury.connect()\n        ]);\n      });\n  },\n\n  /**\n   * Disconnects from WebSocket and unregisters from the Cisco Spark cloud.\n   *\n   * Subsequent calls will be a noop.\n   * @instance\n   * @memberof Phone\n   * @returns {Promise}\n   */\n  deregister() {\n    return this.spark.mercury.disconnect()\n      .then(() => this.spark.device.unregister());\n  },\n\n  /**\n   * Create a MediaStream to be used for video preview.\n   *\n   * Note: You must explicitly pass the resultant stream to {@link Call#answer()}\n   * or {@link Phone#dial()}\n   * @instance\n   * @memberof Phone\n   * @param {Object|MediaStreamConstraints} options\n   * @param {MediaStreamConstraints} options.constraints\n   * @returns {Promise<MediaStream>}\n   */\n  createLocalMediaStream(options) {\n    options = options || {};\n    const constraints = options.constraints || options;\n    defaults(constraints, {\n      audio: true,\n      video: true\n    });\n\n    return getUserMedia(constraints);\n  },\n\n  /**\n   * Initializer\n   * @instance\n   * @memberof Phone\n   * @param {Object} attrs\n   * @param {Object} options\n   * @private\n   * @returns {undefined}\n   */\n  initialize(...args) {\n    Reflect.apply(SparkPlugin.prototype.initialize, this, args);\n\n    this.listenTo(this.spark.mercury, `event:locus`, (event) => this._onLocusEvent(event));\n\n    // Note: we need to manually wire up change:connected because derived props\n    // can't read through this.parent\n    this.listenTo(this.spark.mercury, `change:connected`, () => {\n      this.connected = this.spark.mercury.connected;\n      this.registered = !!this.spark.device.url && this.connected;\n    });\n\n    // Note: we need to manually wire up change:url because derived props\n    // can't read through this.parent\n    this.listenTo(this.spark.device, `change:url`, () => {\n      this.registered = !!this.spark.device.url && this.connected;\n    });\n  },\n\n  /**\n   * Determines if the {@link call:incoming} event should be emitted for the\n   * specified {@link Types~MercuryEvent}\n   * @emits call:incoming\n   * @instance\n   * @memberof Phone\n   * @param {Types~MercuryEvent} event\n   * @returns {undefined}\n   */\n  _onLocusEvent(event) {\n    if (shouldRing(event, this.spark)) {\n      this.trigger(`call:incoming`, Call.make({\n        locus: event.data.locus\n      }, {\n        parent: this.spark\n      }));\n    }\n  },\n\n  /**\n   * Place a call to the specified dialString. A dial string may be an email\n   * address or sip uri.\n   * @instance\n   * @memberof Phone\n   * @param {string} dialString\n   * @param {Object} options\n   * @param {MediaStreamConstraints} options.constraints\n   * @param {MediaStream} options.localMediaStream if no stream is specified, a\n   * new one will be created based on options.constraints\n   * @returns {Call}\n   */\n  dial(dialString, options) {\n    const call = Call.make({}, {parent: this.spark});\n\n    call.dial(dialString, options);\n    return call;\n  }\n});\n\nexport default Phone;\n"]}